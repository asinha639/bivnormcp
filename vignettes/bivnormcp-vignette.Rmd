---
title: "Bayesian Change Point Detection for Bivariate Normal Data"
output: bookdown::html_document2
vignette: >
  %\VignetteIndexEntry{Bayesian Change Point Detection for Bivariate Normal Data}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
library(bivnormcp)
```

# Multiple Change Points Detection under the Bivariate Normal Model

This vignette demonstrates how to use the *bivnormcp* package to detect multiple change points in a sequence of bivariate normal observations. The methodology is Bayesian and assumes the bivariate data follows:
$$
x_i = (x_{1i}, x_{2i})^\top \sim \mathcal{N}_2(\mu_i, \Sigma), \quad i = 1, \dots, n
$$,

where $\mu_i = (\mu_{1i}\;\;\mu_{2i})^\top$ and $\Sigma=\begin{pmatrix}
\sigma_1^2 & \rho\sigma_1\sigma_2\\
\rho\sigma_1\sigma_2 & \sigma_2^2
\end{pmatrix}$

The probability density function of the vector $\mathbf{x}_i$ is given by -
\begin{eqnarray*}
   &&  f(x_{1i},x_{2i}|\mu_{1i},\mu_{2i},\rho) \\
    &=& \frac{1}{2\pi\sqrt{1-\rho^2}}exp\left[-\frac{1}{2(1-\rho^2)}\left\{(x_{1i}-\mu_{1i})^2+(x_{2i}-\mu_{2i})^2-2\rho (x_{1i}-\mu_{1i})(x_{2i}-\mu_{2i})\right\}\right]
\end{eqnarray*}

```{theorem, name="Posterior Probability of Change Point", echo=FALSE}
Let $x_{it}$ denote the $i^{th}$ component of the random vector $\mathbf{x}_t$ corresponding to the time point $t$, where $i=1,2$ and $t=1,2,...,T$. Assume that $\mathbf{x}_t = \left(x_{1t}\;\;x_{2t}\right)^\top \sim N_2(\mathbf{\mu},\Sigma)$, where 
\begin{eqnarray*}
    \mathbf{\mu} = \left(\mu_{1t}\;\;\mu_{2t}\right)^\top \quad \text{and} \quad \Sigma=\begin{pmatrix}
1 & \rho\\
\rho & 1
\end{pmatrix}.
\end{eqnarray*}
Let the joint prior distribution on the parameters, $\mathbf{\mu}$ and $\Sigma$, be the Normal inverse Wishart (NIW) distribution with $pdf$ given by

\begin{eqnarray*}
    f(\mathbf{\mu},\Sigma | \mathbf{\mu}_0, \lambda, \psi, \nu) = \frac{\lambda|\psi|^{\frac{\nu}{2}}|\Sigma|^{-\frac{\nu}{2}-2}}{(2\pi)2^\nu\Gamma_2(\frac{\nu}{2})}exp\left[-\frac{1}{2}tr(\psi\Sigma^{-1})-\frac{\lambda}{2}(\mathbf{\mu}-\mathbf{\mu}_0)^T\Sigma^{-1}(\mathbf{\mu}-\mathbf{\mu}_0)\right],
\end{eqnarray*}
where $\mathbf{\mu}_0 = \left(\mu_{01}\;\;\mu_{02}\right)^\top, \lambda, \psi, \nu$ are all hyper parameters. Then, the posterior probability of the change point being located at $j$th position at time-point (t+1) given data observed up to $t+1$, $\mathbf{x}_{1:t+1}$, is:
\begin{eqnarray}
    P(Q_{t+1}=j|\mathbf{x}_{1:t+1}) \propto \left\{ \begin{array}{ll}
         \omega_{t+1}^j \theta P(Q_{t}=j|\mathbf{x}_{1:t}) & \mbox{if $j < t$}\\
        \omega_{t+1}^j (1-\theta) \sum_{i=0}^{t-1}P(Q_{t}=i|\mathbf{x}_{1:t}) & \mbox{if j = t}\end{array} \right.
\end{eqnarray}\label{eq3}
where the weights are - 
\begin{eqnarray}
    w_{t+1}^j \propto \left\{ \begin{array}{ll}
         \frac{t-j+\lambda}{t-j+\lambda+1}\frac{\int_{-1}^{1} (1-\rho^2)^{-\frac{\nu}{2}-2-\frac{t-j}{2}}exp \left[ -\frac{1}{2(1-\rho^2)} (\eta_{11}-\eta_{12}-\eta_{13}) \right] \,d\rho}{\int_{-1}^{1} (1-\rho^2)^{-\frac{\nu}{2}-2-\frac{t-j-1}{2}}exp \left[ -\frac{1}{2(1-\rho^2)}  (\eta_{21}-\eta_{22}  -\eta_{23})\right]\,d\rho}  & \mbox{if j $<$ t}\\
         \int_{-1}^1 \frac{\lambda }{(\lambda+1)}(1-\rho^2)^{-\frac{\nu}{2}-2}  exp\left[-\frac{1}{2(1-\rho^2)}(\eta_{31} - \eta_{32} - \eta_{33})\right]\,d\rho & \mbox{if j = t}\end{array} \right.
\end{eqnarray}\label{eq4}
and,
\begin{eqnarray*}
\eta_{11}&=& 2 + \displaystyle\sum_{i=j+1}^{t+1}x_{1i}^2 + \displaystyle\sum_{i=j+1}^{t+1}x_{2i}^2 - 2\rho\displaystyle\sum_{i=j+1}^{t+1}x_{1i}x_{2i} + \lambda\mu_{01}^2 -2\lambda\mu_{01}\mu_{02}\rho + \lambda\mu_{02}^2,\\
\eta_{12}&=&\frac{\left(\lambda\mu_{01}-\lambda\mu_{02}\rho+\displaystyle\sum_{i=j+1}^{t+1}x_{1i}-\rho\displaystyle\sum_{i=j+1}^{t+1}x_{2i}\right)^2}{t-j+\lambda+1},\\
\eta_{13}&=&\frac{(1-\rho^2)\left(\lambda\mu_{02}+\displaystyle\sum_{i=j+1}^{t+1}x_{2i}\right)^2}{t-j+\lambda+1},\\
\eta_{21}&=&2 + \displaystyle\sum_{i=j+1}^{t}x_{1i}^2 + \displaystyle\sum_{i=j+1}^{t}x_{2i}^2 - 2\rho\displaystyle\sum_{i=j+1}^{t}x_{1i}x_{2i} + \lambda\mu_{01}^2 -2\lambda\mu_{01}\mu_{02}\rho + \lambda\mu_{02}^2,\\
\eta_{22}&=& \frac{\left(\lambda\mu_{01}-\lambda\mu_{02}\rho+\displaystyle\sum_{i=j+1}^{t}x_{1i}-\rho\displaystyle\sum_{i=j+1}^{t}x_{2i}\right)^2}{t-j+\lambda},\\
\eta_{23}&=&\frac{(1-\rho^2)\left(\lambda\mu_{02}+\displaystyle\sum_{i=j+1}^{t}x_{2i}\right)^2}{t-j+\lambda},\\
\eta_{31}&=& 2 + x_{1,t+1}^2 + x_{2,t+1}^2 - 2\rho x_{1,t+1}x_{2,t+1} + \lambda\mu_{01}^2 -2\lambda\mu_{01}\mu_{02}\rho +\lambda\mu_{02}^2,\\
\eta_{32}&=& \frac{(\lambda\mu_{01}-\lambda\mu_{02}\rho+x_{1,t+1}-\rho x_{2,t+1})^2}{\lambda+1},\\
\eta_{33}&=&\frac{(1-\rho^2)(\lambda\mu_{02}+x_{2,t+1})^2}{\lambda+1}.
\end{eqnarray*}
```

# Usage

## Introduction
This vignette demonstrates how to use the *bivnormcp* package to detect change points in bivariate normal data and visualize them.

## Simulated Example
We'll create a synthetic dataset with two change points:

```{r}
set.seed(123)

test_data <- data.frame(
  var1 = c(rnorm(50, 0, 0.5), rnorm(25, 5, 0.5), rnorm(25, 15, 0.5)),
  var2 = c(rnorm(50, 0, 0.5), rnorm(25, 5, 0.5), rnorm(25, 15, 0.5))
)
```

## Run Change Point Detection
```{r}
result <- bivar_norm_cp(test_data$var1, test_data$var2,
                        th_cp = 0.9,
                        save_output = FALSE)  # we won't save during vignette build
result
```

## Correct the Indices and Visualize Change Points
```{r}
change_pts <- index_correction(result$prob_max[, 2])
plot_cp_3d(result$x1, result$x2, change_pts)
```

